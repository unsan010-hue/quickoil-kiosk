{% extends 'base.html' %}
{% load static humanize %}

{% block title %}QuickOil - 엔진오일 선택{% endblock %}

{% block header_logo %}{% endblock %}

{% block progress %}
{% with current_step=2 %}
{% include 'components/progress_bar.html' %}
{% endwith %}
{% endblock %}

{% block content %}
<div class="bg-white py-6 pb-32">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">

        <!-- 선택된 차량 정보 요약 -->
        <div class="mx-auto max-w-6xl mb-8 p-4 bg-gray-50 rounded-xl">
            <div class="flex items-center justify-center gap-6 text-base">
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">브랜드</span>
                    <span class="font-semibold text-gray-800">{{ brand.name }}</span>
                </div>
                <span class="text-gray-300">|</span>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">차종</span>
                    <span class="font-semibold text-gray-800">{{ car_model.name }}</span>
                </div>
                <span class="text-gray-300">|</span>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">연료</span>
                    <span class="font-semibold text-gray-800">{{ fuel_type.name }}</span>
                </div>
            </div>
        </div>

        <!-- 엔진오일 타이틀 -->
        <div class="mx-auto max-w-6xl text-center mb-10">
            <h2 class="text-2xl font-bold text-gray-900">엔진오일 선택</h2>
            <p class="mt-2 text-base text-gray-600">차량에 맞는 엔진오일을 선택해주세요</p>
        </div>

        <!-- 엔진오일 카드 그리드 -->
        <div class="mx-auto max-w-6xl flex justify-center gap-4">
            {% for tier in oil_tiers %}
            <div class="relative pt-4 {% if is_domestic %}w-1/5{% else %}w-1/3 max-w-xs{% endif %}">
                <!-- 뱃지 (카드 위에 배치) -->
                {% if tier.badge %}
                <div class="absolute top-1 left-1/2 -translate-x-1/2 z-10">
                    <span class="inline-block rounded-full px-3 py-1 text-xs font-bold text-white whitespace-nowrap
                        {% if tier.badge_type == 'recommended' %}bg-orange-500
                        {% elif tier.badge_type == 'popular' %}bg-red-500
                        {% elif tier.badge_type == 'premium' %}bg-gray-900
                        {% endif %}">
                        {{ tier.badge }}
                    </span>
                </div>
                {% endif %}

                <!-- 카드 -->
                <div id="oil-card-{{ tier.id }}"
                    class="oil-card h-full rounded-3xl p-6 ring-1 ring-gray-200 hover:ring-orange-400 transition-all cursor-pointer flex flex-col bg-white {% if tier.id == 'premium' %}ring-2 ring-orange-500{% endif %}"
                    {% if tier.id == 'premium' %}data-featured="true"{% endif %}
                    data-tier-id="{{ tier.id }}"
                    data-tier-name="{{ tier.name }}"
                    data-tier-price="{{ tier.price }}"
                    data-product-name="{{ tier.product_name }}"
                    onclick="selectOil('{{ tier.id }}')">

                    <!-- 등급명 -->
                    <h3 class="text-xl font-bold text-gray-900 text-center mb-3">{{ tier.name }}</h3>

                    <!-- 설명 -->
                    <p class="text-base text-gray-500 text-center mb-4 min-h-[48px]">{{ tier.tagline }}</p>

                    <!-- 제품명 + 오일타입 -->
                    <div class="text-center mb-4">
                        <p class="text-lg font-medium text-gray-900">{{ tier.product_name }}</p>
                        <p class="text-base text-gray-500">{{ tier.oil_type }}</p>
                    </div>

                    <!-- 가격 -->
                    <div class="text-center mb-6">
                        <span class="text-3xl font-bold text-orange-500">{{ tier.price|intcomma }}</span>
                        <span class="text-base font-medium text-gray-500">원</span>
                    </div>

                    <!-- 무료 서비스 체크리스트 -->
                    <ul class="space-y-2 text-base text-gray-600 flex-grow">
                        {% for service in tier.free_services %}
                        <li class="flex gap-x-2 items-center">
                            <svg viewBox="0 0 20 20" fill="currentColor" class="h-5 w-4 flex-none text-green-500">
                                <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                            </svg>
                            <span>{{ service }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 하단 고정 요약 바 -->
<div id="bottom-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg hidden">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
        <!-- 선택 정보 -->
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span id="selected-tier-name" class="font-semibold text-gray-900"></span>
            <span class="text-gray-400">·</span>
            <span id="selected-product-name" class="text-gray-600"></span>
            <span id="selected-price" class="text-xl font-bold text-orange-500 ml-4"></span>
        </div>

        <!-- 다음 버튼 -->
        <a href="#" id="next-btn" class="bg-orange-500 text-white px-8 py-4 rounded-full font-semibold text-lg hover:bg-orange-600 transition-all">
            다음 단계 →
        </a>
    </div>
</div>

<script>
const brandId = '{{ brand_id }}';
const modelId = '{{ model_id }}';
const fuelId = '{{ fuel_id }}';
const carNumber = '{{ car_number|default:"" }}';

let selectedTier = null;

function selectOil(tierId) {
    // 이전 선택 해제
    document.querySelectorAll('.oil-card').forEach(card => {
        card.classList.remove('ring-2', 'ring-orange-500', 'bg-orange-50');
        card.classList.add('ring-1', 'ring-gray-200');
    });

    // 현재 선택 표시
    const selectedCard = document.getElementById('oil-card-' + tierId);
    selectedCard.classList.remove('ring-1', 'ring-gray-200');
    selectedCard.classList.add('ring-2', 'ring-orange-500', 'bg-orange-50');

    // 데이터 저장
    const tierName = selectedCard.dataset.tierName;
    const tierPrice = parseInt(selectedCard.dataset.tierPrice);
    const productName = selectedCard.dataset.productName;

    selectedTier = { id: tierId, name: tierName, price: tierPrice, productName: productName };

    // 하단 바 업데이트
    document.getElementById('selected-tier-name').textContent = tierName;
    document.getElementById('selected-product-name').textContent = productName;
    document.getElementById('selected-price').textContent = tierPrice.toLocaleString() + '원';
    document.getElementById('bottom-bar').classList.remove('hidden');

    // URL 설정
    let url = '/service/?brand=' + brandId + '&model=' + modelId + '&fuel=' + fuelId + '&oil=' + tierId;
    if (carNumber) url += '&car_number=' + encodeURIComponent(carNumber);
    document.getElementById('next-btn').href = url;
}
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}QuickOil - 시작{% endblock %}

{% block header_logo %}{% endblock %}

{% block content %}
<!-- 우상단 직원 메뉴 -->
<div class="fixed top-4 right-4 z-50 flex gap-2">
    <a href="{% url 'reservation_list' %}" class="px-4 py-2 text-sm text-gray-500 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">
        예약 관리
    </a>
    <a href="{% url 'staff_dashboard' %}" class="px-4 py-2 text-sm text-gray-500 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">
        시공 관리
    </a>
    <a href="{% url 'store_settings' %}" class="px-4 py-2 text-sm text-gray-500 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">
        설정
    </a>
</div>

{% if sidebar_items %}
<div class="start-layout">
    <!-- 왼쪽: 오늘의 현황 사이드바 -->
    <div class="reservation-sidebar">
        <div class="sidebar-title">오늘의 현황</div>
        {% for item in sidebar_items %}
        <a href="{% if item.type == 'order' %}{% url 'order_detail' item.id %}{% else %}{% url 'select_car' %}?car_number={{ item.car_number|urlencode }}{% if item.brand_id %}&brand={{ item.brand_id }}{% endif %}{% if item.model_id %}&model={{ item.model_id }}{% endif %}&reservation_id={{ item.id }}{% endif %}"
           class="reservation-item">
            <span class="reservation-time">{{ item.time }}</span>
            <span class="reservation-car">{{ item.display_label }}</span>
            <span class="reservation-model">{{ item.model_name }}</span>
            <span class="sidebar-badge sidebar-badge--{{ item.status }}">{{ item.badge }}</span>
        </a>
        {% endfor %}
    </div>

    <!-- 오른쪽: 기존 폼 -->
    <div class="start-main">
        <div class="logo-wrapper">
            <a href="/">
                <img src="{% static 'images/logo.jpg' %}" alt="QuickOil" class="logo">
            </a>
        </div>

        <form id="start-form" action="{% url 'select_car' %}" method="GET" class="start-form">
            <div class="input-wrapper">
                <input
                    type="tel"
                    id="phone-input"
                    name="phone"
                    placeholder="전화번호 뒷자리 (예: 5678)"
                    class="car-input"
                    autocomplete="off"
                    style="margin-bottom: 12px;"
                >
                <input
                    type="text"
                    id="car-number-input"
                    name="car_number"
                    placeholder="차량번호 입력"
                    class="car-input"
                    autocomplete="off"
                >
            </div>

            <!-- 예약 매칭 결과 -->
            <div id="reservation-info" class="hidden" style="margin-bottom: 16px; padding: 16px; background: #FFF7ED; border-radius: 12px; text-align: center;">
                <p style="color: #EA580C; font-weight: 600; margin-bottom: 4px;">
                    <span id="res-name"></span>님 예약 확인!
                </p>
                <p style="color: #9CA3AF; font-size: 14px;">
                    <span id="res-time"></span> 예약
                </p>
            </div>

            <button type="submit" class="start-button">
                시작하기
            </button>
        </form>
    </div>
</div>
{% else %}
<!-- 예약/시공 없을 때: 기존 레이아웃 -->
<div class="start-container">
    <div class="logo-wrapper">
        <a href="/">
            <img src="{% static 'images/logo.jpg' %}" alt="QuickOil" class="logo">
        </a>
    </div>

    <form id="start-form" action="{% url 'select_car' %}" method="GET" class="start-form">
        <div class="input-wrapper">
            <input
                type="tel"
                id="phone-input"
                name="phone"
                placeholder="전화번호 뒷자리 (예: 5678)"
                class="car-input"
                autocomplete="off"
                style="margin-bottom: 12px;"
            >
            <input
                type="text"
                id="car-number-input"
                name="car_number"
                placeholder="차량번호 입력"
                class="car-input"
                autocomplete="off"
            >
        </div>

        <!-- 예약 매칭 결과 -->
        <div id="reservation-info" class="hidden" style="margin-bottom: 16px; padding: 16px; background: #FFF7ED; border-radius: 12px; text-align: center;">
            <p style="color: #EA580C; font-weight: 600; margin-bottom: 4px;">
                <span id="res-name"></span>님 예약 확인!
            </p>
            <p style="color: #9CA3AF; font-size: 14px;">
                <span id="res-time"></span> 예약
            </p>
        </div>

        <button type="submit" class="start-button">
            시작하기
        </button>
    </form>
</div>
{% endif %}

<script>
const phoneInput = document.getElementById('phone-input');
const carNumberInput = document.getElementById('car-number-input');
const reservationInfo = document.getElementById('reservation-info');
let reservationData = null;

phoneInput.addEventListener('input', function() {
    const phone = this.value.replace(/\D/g, '');

    if (phone.length >= 4) {
        fetch('/api/check-reservation/?phone=' + phone)
            .then(res => res.json())
            .then(data => {
                if (data.found && data.reservation) {
                    reservationData = data.reservation;
                    document.getElementById('res-name').textContent = data.reservation.customer_name || '고객';
                    document.getElementById('res-time').textContent = data.reservation.time;
                    reservationInfo.classList.remove('hidden');

                    // 자동 입력
                    if (data.reservation.car_number) {
                        carNumberInput.value = data.reservation.car_number;
                    }
                } else if (data.customer) {
                    // 예약은 없지만 고객 정보 있음
                    if (data.customer.car_number) {
                        carNumberInput.value = data.customer.car_number;
                    }
                    reservationInfo.classList.add('hidden');
                    reservationData = null;
                } else {
                    reservationInfo.classList.add('hidden');
                    reservationData = null;
                }
            });
    } else {
        reservationInfo.classList.add('hidden');
        reservationData = null;
    }
});

document.getElementById('start-form').addEventListener('submit', function(e) {
    // 예약 정보가 있으면 URL에 추가
    if (reservationData) {
        const url = new URL(this.action);
        if (reservationData.brand_id) url.searchParams.set('brand', reservationData.brand_id);
        if (reservationData.model_id) url.searchParams.set('model', reservationData.model_id);
        if (reservationData.id) url.searchParams.set('reservation_id', reservationData.id);
        this.action = url.toString();
    }
});
</script>
{% endblock %}

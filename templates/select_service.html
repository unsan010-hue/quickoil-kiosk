{% extends 'base.html' %}
{% load static %}

{% block title %}QuickOil - 추가 서비스{% endblock %}

{% block header_logo %}{% endblock %}

{% block progress %}
{% with current_step=3 %}
{% include 'components/progress_bar.html' %}
{% endwith %}
{% endblock %}

{% block content %}
<div class="bg-white py-6">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">

        <!-- 선택 정보 요약 -->
        <div class="mx-auto max-w-4xl mb-8 p-4 bg-gray-50 rounded-xl">
            <div class="flex items-center justify-center gap-6 text-base flex-wrap">
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">차량</span>
                    <span class="font-semibold text-gray-800">{{ brand.name }} {{ car_model.name }}</span>
                </div>
                <span class="text-gray-300">|</span>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">연료</span>
                    <span class="font-semibold text-gray-800">{{ fuel_type.name }}</span>
                </div>
                <span class="text-gray-300">|</span>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">엔진오일</span>
                    <span class="font-semibold text-orange-500">{{ oil.name }} ({{ oil.price|floatformat:0 }}원)</span>
                </div>
            </div>
        </div>

        <!-- 타이틀 -->
        <div class="mx-auto max-w-4xl text-center mb-8">
            <h2 class="text-2xl font-bold text-gray-900">추가 서비스 선택</h2>
            <p class="mt-2 text-base text-gray-600">필요한 서비스를 선택해주세요 (복수 선택 가능)</p>
        </div>

        <!-- 추가 서비스 체크박스 리스트 -->
        {% if services %}
        <div class="mx-auto max-w-4xl space-y-3">
            {% for service in services %}
            <div class="service-item flex items-center justify-between p-5 rounded-xl border-2 border-gray-200 hover:border-orange-400 cursor-pointer transition-all"
                data-service-id="{{ service.id }}"
                data-service-name="{{ service.name }}"
                data-service-price="{{ service.price }}"
                data-checked="false"
                onclick="toggleService(this)">
                <div class="flex items-center gap-4">
                    <!-- 체크박스 표시 -->
                    <div class="checkbox-box w-7 h-7 border-2 border-gray-300 rounded-lg transition-all flex items-center justify-center">
                        <svg class="check-icon w-4 h-4 text-white hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div>
                        <span class="text-lg font-semibold text-gray-800">{{ service.name }}</span>
                        {% if service.description %}
                        <p class="text-sm text-gray-500 mt-1">{{ service.description }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="text-right">
                    {% if service.price > 0 %}
                    <span class="text-xl font-bold text-gray-900">{{ service.price|floatformat:0 }}원</span>
                    {% else %}
                    <span class="text-xl font-bold text-green-600">무료</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center text-gray-400 py-8">추가 서비스가 없습니다</p>
        {% endif %}

        <!-- 선택 요약 및 다음 버튼 -->
        <div class="mx-auto max-w-4xl mt-10">
            <!-- 합계 표시 -->
            <div class="p-5 bg-orange-50 border-2 border-orange-500 rounded-xl mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-gray-600">엔진오일</span>
                        <span class="font-semibold text-gray-800 ml-2">{{ oil.name }}</span>
                    </div>
                    <span class="text-lg font-bold text-gray-800">{{ oil.price|floatformat:0 }}원</span>
                </div>
                <div id="selected-services" class="mt-3 space-y-2">
                    <!-- JavaScript로 동적 추가 -->
                </div>
                <div class="border-t border-orange-200 mt-4 pt-4 flex items-center justify-between">
                    <span class="text-lg font-bold text-gray-900">총 예상 금액</span>
                    <span id="total-price" class="text-2xl font-bold text-orange-500">{{ oil.price|floatformat:0 }}원</span>
                </div>
            </div>

            <a href="#" id="next-btn" class="block w-full px-8 py-5 bg-orange-500 text-white text-center font-semibold text-xl rounded-xl hover:bg-orange-600 transition-all">
                견적서 확인 →
            </a>
        </div>
    </div>
</div>

<script>
const brandId = '{{ brand_id }}';
const modelId = '{{ model_id }}';
const fuelId = '{{ fuel_id }}';
const oilId = '{{ oil_id }}';
const oilPrice = {{ oil.price }};
const carNumber = '{{ car_number|default:"" }}';

function toggleService(item) {
    const isChecked = item.dataset.checked === 'true';
    item.dataset.checked = isChecked ? 'false' : 'true';

    const checkboxBox = item.querySelector('.checkbox-box');
    const checkIcon = item.querySelector('.check-icon');

    if (!isChecked) {
        // 체크
        item.classList.remove('border-gray-200');
        item.classList.add('border-orange-500', 'bg-orange-50');
        checkboxBox.classList.remove('border-gray-300');
        checkboxBox.classList.add('border-orange-500', 'bg-orange-500');
        checkIcon.classList.remove('hidden');
    } else {
        // 체크 해제
        item.classList.remove('border-orange-500', 'bg-orange-50');
        item.classList.add('border-gray-200');
        checkboxBox.classList.remove('border-orange-500', 'bg-orange-500');
        checkboxBox.classList.add('border-gray-300');
        checkIcon.classList.add('hidden');
    }

    updateSelection();
}

function updateSelection() {
    const checkedItems = document.querySelectorAll('.service-item[data-checked="true"]');
    const selectedServicesDiv = document.getElementById('selected-services');
    let servicesTotal = 0;
    let selectedIds = [];
    let html = '';

    checkedItems.forEach(item => {
        const name = item.dataset.serviceName;
        const price = parseInt(item.dataset.servicePrice);
        const id = item.dataset.serviceId;

        selectedIds.push(id);
        servicesTotal += price;

        if (price > 0) {
            html += `<div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">+ ${name}</span>
                <span class="font-semibold text-gray-800">${price.toLocaleString()}원</span>
            </div>`;
        } else {
            html += `<div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">+ ${name}</span>
                <span class="font-semibold text-green-600">무료</span>
            </div>`;
        }
    });

    selectedServicesDiv.innerHTML = html;

    const total = oilPrice + servicesTotal;
    document.getElementById('total-price').textContent = total.toLocaleString() + '원';

    // URL 업데이트
    let url = '/estimate/?brand=' + brandId + '&model=' + modelId + '&fuel=' + fuelId + '&oil=' + oilId;
    if (selectedIds.length > 0) {
        url += '&services=' + selectedIds.join(',');
    }
    if (carNumber) {
        url += '&car_number=' + encodeURIComponent(carNumber);
    }
    document.getElementById('next-btn').href = url;
}

// 초기 URL 설정
updateSelection();
</script>
{% endblock %}

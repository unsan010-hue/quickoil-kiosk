{% extends 'base.html' %}
{% load static humanize %}

{% block title %}QuickOil - 주문 상세{% endblock %}

{% block content %}
<div class="bg-gray-100 min-h-screen py-6">
    <div class="mx-auto max-w-6xl px-6">
        <!-- 헤더 -->
        <div class="flex items-center gap-4 mb-6">
            <a href="{% url 'staff_dashboard' %}" class="p-2 bg-white rounded-lg hover:bg-gray-50">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1 class="text-2xl font-bold text-gray-900">
                {% if order.status == 'completed' %}정비 명세서{% else %}완료 처리{% endif %}
            </h1>
            {% if order.status == 'completed' %}
            <button type="button" id="edit-toggle-btn" class="ml-auto px-3 py-1.5 text-sm text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">
                수정
            </button>
            {% endif %}
        </div>

        {% if order.status == 'completed' %}
        <!-- 명세서 카드 (이미지 캡처용) -->
        <div id="receipt-card" class="bg-white rounded-xl shadow-lg overflow-hidden mb-6 max-w-sm mx-auto" style="width: 320px;">
            <!-- 헤더 -->
            <div class="bg-orange-500 px-4 py-3 text-center">
                <h2 class="text-base font-bold text-white">정비 명세서</h2>
                <p class="text-orange-100 text-xs">QuickOil</p>
            </div>

            <!-- 차량 정보 -->
            <div class="px-4 py-3 border-b border-gray-100 text-sm">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-gray-500">차량번호</span>
                    <span class="font-bold text-gray-900">{{ order.car_number|default:"-" }}</span>
                </div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-gray-500">차종</span>
                    <span class="font-medium text-gray-900">
                        {% if order.brand and order.car_model %}{{ order.brand.name }} {{ order.car_model.name }}{% else %}-{% endif %}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">시공일</span>
                    <span class="font-medium text-gray-900">{{ order.completed_at|date:"Y.m.d" }}</span>
                </div>
            </div>

            <!-- 주행거리 -->
            {% if order.mileage_current %}
            <div class="px-4 py-2 border-b border-gray-100 bg-orange-50 text-sm">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-gray-600">현재</span>
                    <span class="font-bold text-gray-900">{{ order.mileage_current|intcomma }} km</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">다음 교체</span>
                    <span class="font-bold text-orange-600">{{ order.mileage_next|intcomma }} km</span>
                </div>
            </div>
            {% endif %}

            <!-- 서비스 내역 -->
            <div class="px-4 py-3 text-sm">
                <div class="space-y-1">
                    <div class="flex justify-between items-center py-1 border-b border-gray-50">
                        <div>
                            <span class="font-medium text-gray-900">{{ order.oil_name }}</span>
                            <span class="text-xs text-gray-400 ml-1">{{ order.oil_product_name }}</span>
                        </div>
                        <span class="font-bold text-gray-900">{{ order.oil_price|intcomma }}</span>
                    </div>
                    {% for item in order.services.all %}
                    <div class="flex justify-between items-center py-1 border-b border-gray-50">
                        <span class="font-medium text-gray-900">{{ item.name }}</span>
                        <span class="font-bold text-gray-900">{% if item.price > 0 %}{{ item.price|intcomma }}{% else %}무료{% endif %}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- 합계 -->
            <div class="px-4 py-3 bg-gray-50">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-gray-900">총 금액</span>
                    <span class="text-lg font-bold text-orange-500">{{ order.total_price|intcomma }}원</span>
                </div>
            </div>

            <!-- 특이사항 -->
            {% if order.notes %}
            <div class="px-4 py-2 border-t border-gray-100 text-xs">
                <p class="text-gray-500">{{ order.notes }}</p>
            </div>
            {% endif %}

            <!-- 푸터 -->
            <div class="px-4 py-2 bg-gray-100 text-center">
                <p class="text-xs text-gray-400">감사합니다 - QuickOil</p>
            </div>
        </div>

        <!-- 버튼들 (세로 배치) -->
        <div class="space-y-3 mb-6 max-w-sm mx-auto">
            <button type="button" id="copy-text-btn" class="w-full px-4 py-3 bg-yellow-400 text-gray-900 font-semibold rounded-xl hover:bg-yellow-500 transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                </svg>
                텍스트 복사
            </button>
            <button type="button" id="save-image-btn" class="w-full px-4 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                이미지 저장
            </button>
        </div>

        <!-- 카카오톡 알림톡 발송 -->
        <div class="bg-white rounded-xl p-4 mb-6 max-w-sm mx-auto">
            <label class="block text-sm font-medium text-gray-700 mb-2">휴대폰 번호</label>
            <input type="tel" id="phone-input" value="{{ order.customer_phone|default:'' }}"
                placeholder="010-0000-0000"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 mb-3">
            <button type="button" id="send-kakao-btn" class="w-full px-4 py-3 bg-yellow-300 text-gray-900 font-semibold rounded-xl hover:bg-yellow-400 transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3C6.48 3 2 6.58 2 11c0 2.76 1.78 5.18 4.44 6.56-.14.51-.56 2.07-.64 2.39-.1.38.14.37.29.27.12-.08 1.87-1.27 2.63-1.79.73.11 1.49.17 2.28.17 5.52 0 10-3.58 10-8s-4.48-8-10-8z"/>
                </svg>
                카카오톡 발송
            </button>
        </div>

        <!-- 수정 폼 (숨김) -->
        <form id="edit-form" method="post" class="bg-white rounded-2xl shadow-sm overflow-hidden mb-6 hidden">
            {% csrf_token %}
            <div class="px-6 py-5 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">현재 주행거리 (km)</label>
                    <input type="number" name="mileage_current" value="{{ order.mileage_current|default:'' }}"
                        class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">특이사항</label>
                    <textarea name="notes" rows="3"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">{{ order.notes }}</textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex gap-3">
                <button type="button" id="cancel-edit-btn" class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">
                    취소
                </button>
                <button type="submit" name="action" value="save" class="flex-1 px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600">
                    저장
                </button>
            </div>
        </form>

        {% else %}
        <!-- 미완료: 입력 폼 -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-6">
            <!-- 차량/서비스 정보 -->
            <div class="px-6 py-5 border-b border-gray-200">
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-500">차량번호</span>
                        <span class="font-bold text-gray-900 text-lg">{{ order.car_number|default:"-" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">차종</span>
                        <span class="font-semibold text-gray-900">
                            {% if order.brand and order.car_model %}{{ order.brand.name }} {{ order.car_model.name }}{% else %}-{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-gray-900">{{ order.oil_name }}</span>
                    <span class="font-bold text-gray-900">{{ order.oil_price|intcomma }}원</span>
                </div>
                {% for item in order.services.all %}
                <div class="flex justify-between items-center text-sm">
                    <span class="text-gray-600">{{ item.name }}</span>
                    <span class="text-gray-900">{% if item.price > 0 %}{{ item.price|intcomma }}원{% else %}무료{% endif %}</span>
                </div>
                {% endfor %}
            </div>

            <div class="px-6 py-4 bg-gray-50">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-gray-900">총 금액</span>
                    <span class="text-xl font-bold text-orange-500">{{ order.total_price|intcomma }}원</span>
                </div>
            </div>
        </div>

        <!-- 시공 정보 입력 -->
        <form method="post" class="bg-white rounded-2xl shadow-sm overflow-hidden mb-6">
            {% csrf_token %}
            <div class="px-6 py-5 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">현재 주행거리 (km)</label>
                    <input type="number" name="mileage_current" value="{{ order.mileage_current|default:'' }}"
                        class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                        placeholder="예: 50000">
                    <p class="mt-2 text-sm text-gray-500">* 다음 교체: +{{ mileage_interval|intcomma }}km</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">특이사항</label>
                    <textarea name="notes" rows="3"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                        placeholder="특이사항이 있으면 입력해주세요">{{ order.notes }}</textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex gap-3">
                <button type="submit" name="action" value="save" class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">
                    저장
                </button>
                <button type="submit" name="action" value="complete" class="flex-1 px-6 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600">
                    완료
                </button>
            </div>
        </form>
        {% endif %}

        <!-- 시간 정보 -->
        <div class="text-sm text-gray-500 text-center space-y-1">
            <p>접수: {{ order.created_at|date:"Y.m.d H:i" }}</p>
            {% if order.completed_at %}
            <p>완료: {{ order.completed_at|date:"Y.m.d H:i" }}</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- html2canvas 라이브러리 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
{% if order.status == 'completed' %}
// 수정 토글
const editToggleBtn = document.getElementById('edit-toggle-btn');
const editForm = document.getElementById('edit-form');
const receiptCard = document.getElementById('receipt-card');
const cancelEditBtn = document.getElementById('cancel-edit-btn');

editToggleBtn.addEventListener('click', function() {
    editForm.classList.remove('hidden');
    receiptCard.classList.add('hidden');
    editToggleBtn.classList.add('hidden');
});

cancelEditBtn.addEventListener('click', function() {
    editForm.classList.add('hidden');
    receiptCard.classList.remove('hidden');
    editToggleBtn.classList.remove('hidden');
});

// 텍스트 복사
document.getElementById('copy-text-btn').addEventListener('click', function() {
    let text = '[ QuickOil 정비 명세서 ]\n\n';
    text += '차량번호: {{ order.car_number|default:"-" }}\n';
    text += '차종: {% if order.brand and order.car_model %}{{ order.brand.name }} {{ order.car_model.name }}{% else %}-{% endif %}\n';
    text += '시공일: {{ order.completed_at|date:"Y.m.d" }}\n';
    {% if order.mileage_current %}
    text += '\n현재: {{ order.mileage_current|intcomma }}km\n';
    text += '다음 교체: {{ order.mileage_next|intcomma }}km\n';
    {% endif %}
    text += '\n─────────────\n';
    text += '{{ order.oil_name }} ({{ order.oil_product_name }}): {{ order.oil_price|intcomma }}원\n';
    {% for item in order.services.all %}
    text += '{{ item.name }}: {% if item.price > 0 %}{{ item.price|intcomma }}원{% else %}무료{% endif %}\n';
    {% endfor %}
    text += '─────────────\n';
    text += '총 금액: {{ order.total_price|intcomma }}원\n';
    {% if order.notes %}
    text += '\n※ {{ order.notes }}\n';
    {% endif %}
    text += '\n감사합니다 - QuickOil';

    navigator.clipboard.writeText(text).then(() => {
        alert('클립보드에 복사되었습니다!');
    });
});

// 이미지 저장
document.getElementById('save-image-btn').addEventListener('click', function() {
    const receiptEl = document.getElementById('receipt-card');

    html2canvas(receiptEl, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'QuickOil_{{ order.car_number|default:"" }}_{{ order.completed_at|date:"Ymd" }}.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
});

// 카카오톡 발송
document.getElementById('send-kakao-btn').addEventListener('click', function() {
    const phoneInput = document.getElementById('phone-input');
    const phone = phoneInput.value.trim();

    if (!phone) {
        alert('휴대폰 번호를 입력해주세요.');
        phoneInput.focus();
        return;
    }

    if (!confirm(phone + '로 알림톡을 발송하시겠습니까?')) return;

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 발송 중...';

    fetch('/api/order/{{ order.id }}/send-alimtalk/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ phone: phone }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('알림톡이 발송되었습니다!');
            btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> 발송 완료';
            btn.classList.remove('bg-yellow-300', 'hover:bg-yellow-400');
            btn.classList.add('bg-green-400');
        } else {
            alert('발송 실패: ' + (data.error || '알 수 없는 오류'));
            btn.disabled = false;
            btn.innerHTML = '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C6.48 3 2 6.58 2 11c0 2.76 1.78 5.18 4.44 6.56-.14.51-.56 2.07-.64 2.39-.1.38.14.37.29.27.12-.08 1.87-1.27 2.63-1.79.73.11 1.49.17 2.28.17 5.52 0 10-3.58 10-8s-4.48-8-10-8z"/></svg> 카카오톡 발송';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('발송 중 오류가 발생했습니다.');
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C6.48 3 2 6.58 2 11c0 2.76 1.78 5.18 4.44 6.56-.14.51-.56 2.07-.64 2.39-.1.38.14.37.29.27.12-.08 1.87-1.27 2.63-1.79.73.11 1.49.17 2.28.17 5.52 0 10-3.58 10-8s-4.48-8-10-8z"/></svg> 카카오톡 발송';
    });
});
{% endif %}
</script>
{% endblock %}
